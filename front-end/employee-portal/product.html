<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alex Bank</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="icon" type="image/x-icon" href="../img/favicon.ico" />
  <meta name="theme-color" content="rgb(131, 152, 162)" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../src/style.css">
  <script src="../src/functions.js"></script>
</head>

<body>
    <div id="app">
        <nav class="navbar">
          <div class="wrapper">
            <a href="../index.html">
              <img src="../img/alex_bank.png" alt="Logo">
            </a>
              <ul>
                <li><a v-if="isLoggedIn && ['A', 'C', 'E'].includes(user_role)" href="index.html">Employee Portal</a></li>
                <li><a v-if="!isLoggedIn" href="../login/index.html">Log In</a></li>
                <li><a v-if="isLoggedIn" href="../myaccount/index.html">My Account</a></li>
              </ul>
          </div>
        </nav>

        <div v-if="isLoggedIn && ['A', 'C', 'E'].includes(user_role)" class="content">
            <div class="two-column-container">
                <div class="column first-column">
                    <div>
                        <ul class="StepProgress" v-if="product_status_progression != null">
                            <li v-for="status in product_data.statuses.slice(0, -1)" class="StepProgress-item is-done"><strong>{{status.status_name}}</strong>
                                {{status.status_update_dt}}
                            </li>
                            <li class="StepProgress-item current"><strong>{{product_data.statuses[product_data.statuses.length-1].status_name}}</strong>
                                {{product_data.statuses[product_data.statuses.length-1].status_update_dt}}
                            </li>
                            <li v-for="status in product_status_progression" class="StepProgress-item"> <strong>{{status.status_name}}</strong>
                            </li>
                            

                          <!-- <li class="StepProgress-item is-done"><strong>Post a contest</strong></li>
                          <li class="StepProgress-item is-done"><strong>Award an entry</strong>
                            Got more entries that you love? Buy more entries anytime! Just hover on your favorite entry and click the Buy button Got more entries that you love? Buy more entries anytime! Just hover on your favorite entry and click the Buy button
                          </li>
                          <li class="StepProgress-item current"><strong>Post a contest</strong></li>
                          <li class="StepProgress-item"><strong>Handover</strong></li>
                          <li class="StepProgress-item"><strong>Provide feedback</strong></li>-->
                        </ul> 
                        </div>
                </div>
                <div class="column second-column">Second Column</div>
            </div>
        </div>

        <div v-else-if="isLoggedIn && ['A', 'C', 'E'].includes(user_role) && !Object.keys(this.account_data).length" class="content">
            <div style="text-align: center; color: red;"><h2>This account does not exist.</h2></div>
        </div>

        <div v-else class="content">
            <div style="text-align: center; color: red;"><h2>You are not logged in.</h2></div>
        </div> 

    </div>

    <script>
        const { createApp } = Vue;
    
        createApp({
            data() {
                return {
                    isLoggedIn: isLoggedIn(),
                    usr_account_id: sessionStorage.getItem("account_id"),
                    user_role: sessionStorage.getItem("user_role"),
                    account_id: null, 
                    product_uid: null, 
                    product_data: null,
                    product_status_progression: null, 
                    product_details: null
                };
            },
            mounted() {
                this.loadPage()
            },
            methods: {
                async loadPage(){
                    const url = new URL(window.location.href);
                    const params = new URLSearchParams(url.search);
                    this.product_uid = params.get("product_uid");
                    this.account_id = params.get("account_id");

                    try {
                        const response = await fetch(`${API_BASE_URL}/account/${this.account_id}/product/${this.product_uid}?usr_account_id=${this.usr_account_id}`, {
                            method: "GET", 
                            headers: {
                                "Content-Type": "application/json",
                                "token": sessionStorage.getItem("token")
                            }
                        });
                        const data = await response.json();
                        if (!response.ok) {
                            console.error('Error:', data);
                            alert("Error loading product information")
                            return; 
                        }

                        this.product_data = data;
                        console.log(this.product_data);

                        const response2 = await fetch(`${API_BASE_URL}/front-end/status-progression?current_status=${this.product_data.statuses[this.product_data.statuses.length-1].status_code}`, {
                            method: "GET"
                        });

                        const data2 = await response2.json();
                        if (!response.ok) {
                            console.error('Error:', data2);
                            alert("Error loading product information")
                            return; 
                        }

                        // this.product_status_progression = data2;
                        // console.log(this.product_status_progression);

                        // const response3 = await fetch(`${API_BASE_URL}/front-end/status-progression?current_status=${this.product_data.statuses[this.product_data.statuses.length-1].status_code}`, {
                        //     method: "GET"
                        // });

                        // const data3 = await response3.json();
                        // if (!response.ok) {
                        //     console.error('Error:', data3);
                        //     alert("Error loading product information")
                        //     return; 
                        // }

                    } catch (error) {
                        console.error('Error loading product information:', error);
                    }
                }
            }
        }).mount('#app');
    </script>
    

</body>
</html>
